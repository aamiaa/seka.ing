<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" class="h-100">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=0.7">
	<title>seka.ing - Event Tracker</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="/assets/flipdown.min.css" rel="stylesheet">
	<style>
		.table-row-tracked {
			--bs-table-bg: #ffc0cb;
			--bs-table-hover-bg: #efafbb;
		}
	</style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center" style="min-height: 100%;">
	<script src="/assets/flipdown.min.js"></script>

	<div id="issuesBanner" style="display: none;" class="sticky-top w-100 py-3 bg-danger text-center rounded-bottom">
		<span>We're experiencing issues. The leaderboard might not be up to date!</span>
	</div>
	
	<div class="my-3">
		<img id="eventLogo" width="300">
		<img id="eventChapterCharacter" width="90">
	</div>
	<div id="eventCountdown" class="flipdown mb-3"></div>

	<div class="row w-100 justify-content-center">
		<div class="col-auto">
			<div class="card bg-white">
				<div class="card-body">
					<table id="eventTable" class="table table-hover table-light" style="--bs-table-bg: white;">
						<thead>
							<tr>
								<th scope="col">#</th>
								<th scope="col">Name</th>
								<th scope="col">Points</th>
								<th scope="col">Past hour</th>
								<th scope="col">Per game</th>
							</tr>
						</thead>
						<tbody id="eventTableBody" class="table-group-divider">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
	
	<p id="errorMsg" style="display: none;">Failed to fetch updated leaderboard. Try again later.</p>

	<footer class="py-3">
		<span>Contact: neo@seka.ing</span>
	</footer>

	<script>
		function formatNumber(num) {
			return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
		}

		async function getLeaderboard() {
			try {
				const res = await fetch("/api/leaderboard")
				if(!res.ok) {
					console.error("getLeaderboard() failed (1):", res.status)
					return null
				}

				const json = await res.json()
				return json
			} catch(ex) {
				console.error("getLeaderboard() failed (2):", ex)
				return null
			}
		}

		let timerStarted = false
		let trackHash = localStorage.getItem("trackHash")
		async function updateLeaderboard() {
			const table = document.getElementById("eventTable")
			const errorMsg = document.getElementById("errorMsg")

			const data = await getLeaderboard()
			if(!data) {
				document.getElementById("issuesBanner").style.display = ""
				return
			}
			
			if(data.update_error) {
				document.getElementById("issuesBanner").style.display = ""
			} else {
				document.getElementById("issuesBanner").style.display = "none"
			}
			
			const eventData = data.event
			document.getElementById("eventLogo").setAttribute("src", `assets/${eventData.name_key}.png`)
			if(eventData.chapter_character) {
				document.getElementById("eventChapterCharacter").setAttribute("src", `assets/character_${eventData.chapter_character}.png`)
			}
			if(eventData.ends_at && !timerStarted) {
				timerStarted = true
				
				const eventEndsAt = new Date(eventData.ends_at)
				const flipdown = new FlipDown(Math.floor(eventEndsAt.getTime()/1000), "eventCountdown", {theme: "light"})
				flipdown.start()
			}

			const lbData = data.rankings
			if(!lbData) {
				table.style.display = "none"
				errorMsg.style.removeProperty("display")
				return
			} else {
				table.style.removeProperty("display")
				errorMsg.style.display = "none"
			}

			const tableBody = document.getElementById("eventTableBody")
			while(tableBody.firstChild) {
				tableBody.removeChild(tableBody.lastChild)
			}

			let scrollTo
			for(const slot of lbData) {
				const tableRow = document.createElement("tr")

				const rankCell = document.createElement("td")
				const nameCell = document.createElement("td")
				const nameCellDiv = document.createElement("div")
				const pointsCell = document.createElement("td")
				const deltaCell = document.createElement("td")
				const avgCell = document.createElement("td")

				rankCell.setAttribute("scope", "row")
				if([1,2,3].includes(slot.rank)) {
					rankCell.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-crown w-6 h-6 text-yellow-400"><path d="M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z"></path><path d="M5 21h14"></path></svg>`
				} else {
					rankCell.innerText = slot.rank
				}

				nameCellDiv.setAttribute("class", "d-flex align-items-center gap-1")
				if(slot.team != null) {
					const teamImg = document.createElement("img")
					teamImg.setAttribute("src", `/assets/team_${slot.team}.png`)
					teamImg.setAttribute("width", "20")
					teamImg.setAttribute("height", "20")

					nameCellDiv.appendChild(teamImg)
				}
				const nameLabel = document.createElement("span")
				nameLabel.innerText = slot.name
				nameCellDiv.appendChild(nameLabel)
				nameCell.appendChild(nameCellDiv)

				pointsCell.innerText = formatNumber(slot.score)
				deltaCell.innerText = !!slot.delta ? "+" + formatNumber(slot.delta) : "-"
				avgCell.innerText = !!slot.average ? "+" + formatNumber(Math.floor(slot.average)) : "-"

				if([3, 10, 50].includes(slot.rank - 1)) {
					tableRow.classList.add("class", "table-group-divider")
				}
				if(trackHash === slot.hash) {
					tableRow.classList.add("table-row-tracked")
					scrollTo = tableRow
				}

				rankCell.setAttribute("class", "fw-bold text-center")
				switch(slot.rank) {
					case 1:
						rankCell.style.color = "#facc15"
						break
					case 2:
						rankCell.style.color = "#9ca3af"
						break
					case 3:
						rankCell.style.color = "#d97706"
						break
					default:
						rankCell.style.color = "#00ccbb"
						break
				}
				pointsCell.style.color = "#ff55ab"

				tableRow.appendChild(rankCell)
				tableRow.appendChild(nameCell)
				tableRow.appendChild(pointsCell)
				tableRow.appendChild(deltaCell)
				tableRow.appendChild(avgCell)

				tableBody.appendChild(tableRow)

				tableRow.addEventListener("click", function() {
					if(trackHash === slot.hash) {
						trackHash = null
						localStorage.removeItem("trackHash")
						this.classList.remove("table-row-tracked")
					} else {
						trackHash = slot.hash
						localStorage.setItem("trackHash", slot.hash)
						document.querySelector(".table-row-tracked")?.classList?.remove("table-row-tracked")
						this.classList.add("table-row-tracked")
					}
				})
			}

			if(scrollTo) {
				scrollTo.scrollIntoView({behavior: "smooth", block: "center"})
			}
		}

		updateLeaderboard()
		setInterval(updateLeaderboard, 30 * 1000)
	</script>
</body>
</html>
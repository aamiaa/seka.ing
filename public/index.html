<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" class="h-100">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=0.7">
	<meta name="description" content="Event leaderboard tracker for Project Sekai.">
	<title>Project Sekai Event Tracker | Sekaing</title>

	<link rel="icon" type="image/x-icon" href="/favicon.ico">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link href="/assets/flipdown.min.css" rel="stylesheet">
	<link rel="stylesheet" href="/assets/style.css">
	<style>
		.table-row-tracked {
			--bs-table-bg: #ffc0cb;
			--bs-table-hover-bg: #efafbb;
		}

		.username-label {
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
		}

		.username-clickable:hover {
			cursor: pointer;
			text-decoration: underline;
		}

		.avatar-clickable:hover {
			cursor: pointer;
		}

		.username-cell {
			max-width: 20ch;
		}
			
		@media (max-width: 768px) {
			.username-cell {
				max-width: 18ch;
			}
		}

		.nav-link {
			--bs-nav-link-color: white;
			--bs-nav-link-hover-color: #d1d1d1;
		}

		.announcement-banner {
			background-color: #ff77ab;
			height: 32px;
			opacity: 0.9;
		}

		.slide-parent {
			container-type: inline-size; /* https://stackoverflow.com/a/75443310 */
		}

		.slide-child {
			animation: scroll-anim 15s linear 1;
		}

		@keyframes fade-in-anim {
			0% {
				opacity: 0;
			}
			100% {
				opacity: 0.9;
			}
		}

		@keyframes fade-out-anim {
			0% {
				opacity: 0.9;
			}
			100% {
				opacity: 0;
			}
		}

		@keyframes scroll-anim {
			0% {
				transform: translateX(100cqw);
			}
			100% {
				transform: translateX(-100%);
			}
		}

		.past-hour-by-rank-col {
			white-space: nowrap;
		}

		.no-select {
			user-select: none;
		}
	</style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center" style="min-height: 100%;">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="/assets/flipdown.min.js"></script>
	<script src="/assets/countdown.min.js"></script>
	<script src="/assets/updater.js"></script>

	<div class="sticky-top w-100">
		<div id="announcementBanner" role="marquee" style="display: none; animation: fade-in-anim 0.5s linear 1;" class="announcement-banner slide-parent py-1 overflow-hidden">
			<div id="announcementMessageContainer" class="slide-child d-inline-block">
				<span id="announcementMessage" class="text-white text-nowrap">The Osechi group's Team Class Leader has won in the x10 special match!</span>
			</div>
		</div>
		<div id="issuesBanner" role="alert" style="display: none;" class="py-3 bg-danger text-center rounded-bottom">
			<span id="issuesBannerLabel"></span>
		</div>
		<div id="gameMaintenanceBanner" role="alert" style="display: none;" class="py-3 alert alert-warning alert-dismissible show text-center">
			<span id="gameMaintenanceBannerLabel"></span>
			<a id="gameMaintenanceBannerNewsLink" style="display: none;" target="_blank"><br>More Info</a>
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
		</div>
	</div>

	<header id="nextLogoContainer" class="my-3 d-flex justify-content-center align-items-center gap-1 d-none">
		<img id="nextEventLogo" alt="Next event logo" width="300" height="128">
		<img style="display: none;" id="nextEventChapterCharacter" alt="Worldlink chapter character icon" width="90" height="90">
	</header>

	<div id="nextEventCountdown" aria-label="Next event countdown" role="timer" class="mb-3 d-none">
		<div id="nextEventCountdownClock" aria-hidden="true" class="flipdown"></div>
	</div>

	<hr id="eventSeparator" role="none" class="w-100 d-none">
	
	<header id="logoContainer" class="my-3 d-flex justify-content-center align-items-center gap-1">
		<span id="eventLogoPlaceholder" aria-hidden="true" class="placeholder-glow" style="width: 300px; height: 128px;">
			<span class="placeholder rounded-4 w-100 h-100"></span>
		</span>
		<img style="display: none;" id="eventLogo" alt="Event logo" width="300" height="128">
		<img style="display: none;" id="eventChapterCharacter" alt="Worldlink chapter character icon" width="90" height="90">
		<div id="ccTeamsContainer" class="d-none ms-2 d-flex flex-column justify-content-center align-items-start">
			<div class="d-flex justify-content-center align-items-center gap-1">
				<img id="ccTeam1Img" alt="Team 1 icon" width="60">
				<div class="d-flex flex-column">
					<p id="ccTeam1Bonus" class="mb-0 fw-bold">N/A</p>
					<p id="ccTeam1MidtermContainer" style="display: none;" class="mb-0">
						<span id="ccTeam1MidtermLabel"></span>
						<span id="ccTeam1MidtermPoints" style="color: #ff55ab;">N/A</span>
					</p>
				</div>
			</div>
			<div class="d-flex justify-content-center align-items-center gap-1">
				<img id="ccTeam2Img" alt="Team 2 icon" width="60">
				<div class="d-flex flex-column">
					<p id="ccTeam2Bonus" class="mb-0 fw-bold">N/A</p>
					<p id="ccTeam2MidtermContainer" style="display: none;" class="mb-0">
						<span id="ccTeam2MidtermLabel"></span>
						<span id="ccTeam2MidtermPoints" style="color: #ff55ab;">N/A</span>
					</p>
				</div>
			</div>
		</div>
	</header>

	<div id="eventCountdownPlaceholder" aria-hidden="true" class="flipdown mb-3 placeholder-glow">
		<span class="placeholder rounded-4 w-100 h-100"></span>
	</div>
	<div style="display: none;" id="eventCountdown" aria-label="Event countdown" role="timer" class="mb-3">
		<div id="eventCountdownClock" aria-hidden="true" class="flipdown"></div>
	</div>

	<p id="eventInfoMsg" style="display:none;" class="text-center mb-0"></p>

	<div id="rankingContainer" class="row w-100 justify-content-center">
		<div class="col-auto">
			<ul class="nav nav-tabs border-bottom-0" id="chapterTabs" role="tablist" data-bs-theme="light" style="display: none;">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall-tab-pane" type="button" role="tab" aria-controls="overall-tab-pane" aria-selected="true" style="--bs-nav-tabs-link-active-bg: white;">Overall</button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-1-tab" data-bs-toggle="tab" data-bs-target="#chapter-1-tab-pane" type="button" role="tab" aria-controls="chapter-1-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-2-tab" data-bs-toggle="tab" data-bs-target="#chapter-2-tab-pane" type="button" role="tab" aria-controls="chapter-2-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-3-tab" data-bs-toggle="tab" data-bs-target="#chapter-3-tab-pane" type="button" role="tab" aria-controls="chapter-3-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-4-tab" data-bs-toggle="tab" data-bs-target="#chapter-4-tab-pane" type="button" role="tab" aria-controls="chapter-4-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-5-tab" data-bs-toggle="tab" data-bs-target="#chapter-5-tab-pane" type="button" role="tab" aria-controls="chapter-5-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-6-tab" data-bs-toggle="tab" data-bs-target="#chapter-6-tab-pane" type="button" role="tab" aria-controls="chapter-6-tab-pane" aria-selected="false"></button>
				</li>
			</ul>
			<div id="eventTableCard" class="card" style="background-color: white;">
				<div class="card-body">
					<div class="tab-content">
						<div class="tab-pane fade show active" id="overall-tab-pane" role="tabpanel" aria-labelledby="overall-tab" tabindex="0">
							<table id="eventTableOverall" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableOverallBody" class="table-group-divider">
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="tab-pane fade" id="chapter-1-tab-pane" role="tabpanel" aria-labelledby="chapter-1-tab" tabindex="0">
							<table id="eventTableChapter1" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableChapter1Body" class="table-group-divider"></tbody>
							</table>
							<div id="eventTableChapter1Countdown" style="display: none;" class="p-4">
								<h4 class="text-dark text-center">Chapter starts at:</h4>
								<h3 id="eventTableChapter1CountdownLabel" class="text-dark text-center"></h3>
							</div>
						</div>
						<div class="tab-pane fade" id="chapter-2-tab-pane" role="tabpanel" aria-labelledby="chapter-2-tab" tabindex="0">
							<table id="eventTableChapter2" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableChapter2Body" class="table-group-divider"></tbody>
							</table>
							<div id="eventTableChapter2Countdown" style="display: none;" class="p-4">
								<h4 class="text-dark text-center">Chapter starts at:</h4>
								<h3 id="eventTableChapter2CountdownLabel" class="text-dark text-center"></h3>
							</div>
						</div>
						<div class="tab-pane fade" id="chapter-3-tab-pane" role="tabpanel" aria-labelledby="chapter-3-tab" tabindex="0">
							<table id="eventTableChapter3" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableChapter3Body" class="table-group-divider"></tbody>
							</table>
							<div id="eventTableChapter3Countdown" style="display: none;" class="p-4">
								<h4 class="text-dark text-center">Chapter starts at:</h4>
								<h3 id="eventTableChapter3CountdownLabel" class="text-dark text-center"></h3>
							</div>
						</div>
						<div class="tab-pane fade" id="chapter-4-tab-pane" role="tabpanel" aria-labelledby="chapter-4-tab" tabindex="0">
							<table id="eventTableChapter4" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableChapter4Body" class="table-group-divider"></tbody>
							</table>
							<div id="eventTableChapter4Countdown" style="display: none;" class="p-4">
								<h4 class="text-dark text-center">Chapter starts at:</h4>
								<h3 id="eventTableChapter4CountdownLabel" class="text-dark text-center"></h3>
							</div>
						</div>
						<div class="tab-pane fade" id="chapter-5-tab-pane" role="tabpanel" aria-labelledby="chapter-5-tab" tabindex="0">
							<table id="eventTableChapter5" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableChapter5Body" class="table-group-divider"></tbody>
							</table>
							<div id="eventTableChapter5Countdown" style="display: none;" class="p-4">
								<h4 class="text-dark text-center">Chapter starts at:</h4>
								<h3 id="eventTableChapter5CountdownLabel" class="text-dark text-center"></h3>
							</div>
						</div>
						<div class="tab-pane fade" id="chapter-6-tab-pane" role="tabpanel" aria-labelledby="chapter-6-tab" tabindex="0">
							<table id="eventTableChapter6" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col" class="past-hour-col">Past hour</th>
										<th scope="col" class="per-game-col">Per game</th>
										<th scope="col" class="past-hour-by-rank-col" style="display: none;">Past hour <u>by tier</u></th>
									</tr>
								</thead>
								<tbody id="eventTableChapter6Body" class="table-group-divider"></tbody>
							</table>
							<div id="eventTableChapter6Countdown" style="display: none;" class="p-4">
								<h4 class="text-dark text-center">Chapter starts at:</h4>
								<h3 id="eventTableChapter6CountdownLabel" class="text-dark text-center"></h3>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h1 id="contactModalLabel" class="modal-title fs-5">Contact</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div id="contactModalBody" class="modal-body">
					<p class="placeholder-glow" aria-hidden="true">
						<span class="placeholder col-7"></span>
						<span class="placeholder col-4"></span>
						<span class="placeholder col-4"></span>
						<span class="placeholder col-6"></span>
						<span class="placeholder col-8"></span>
					</p>
				</div>
			</div>
		</div>
	</div>
	
	<p id="errorMsg" style="display: none;">Failed to fetch updated leaderboard. Try again later.</p>

	<div class="mt-3">
		<div class="form-check form-switch">
			<input class="form-check-input" type="checkbox" role="switch" id="showBordersCb">
			<label class="form-check-label" for="showBordersCb">Show Highlights</label>
		</div>
		<div class="form-check form-switch">
			<input class="form-check-input" type="checkbox" role="switch" id="compactModeCb">
			<label class="form-check-label" for="compactModeCb">Compact Mode</label>
		</div>
		<div class="form-check form-switch d-none">
			<input class="form-check-input" type="checkbox" role="switch" id="showCCAnnounceCb" checked>
			<label class="form-check-label" for="showCCAnnounceCb">Show Cheerful Carnival sliding messages</label>
		</div>
	</div>

	<div class="modal" id="eventProfileModal" tabindex="-1" aria-labelledby="eventProfileModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fw-normal fs-5" id="eventProfileModalLabel">...</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body d-flex flex-column gap-3">
					<div>
						<h4>Current Team</h4>
						<div id="eventProfileDeck" class="d-flex gap-2 no-select mb-3"></div>
						<div>
							<details id="eventProfileTalentDetails">
								<summary>Talent: <span id="eventProfileTalentLb" class="fw-bold"></span></summary>
								<p id="eventProfileBaseTalentLb" class="mb-0">Base Talent:</p>
								<p id="eventProfileItemTalentLb" class="mb-0">Decoration Bonus:</p>
								<p id="eventProfileCRTalentLb" class="mb-0">Character Rank Bonus:</p>
								<p id="eventProfileTitleTalentLb" class="mb-0">Title Bonus:</p>
							</details>
						</div>
						<p>Event Bonus: <span id="eventProfileBonusLb" class="fw-bold"></span></p>
					</div>
					<div>
						<h4>Recent Games</h4>
						<div style="height: 6rem; width: 100%;">
							<canvas id="recentGamesChart"></canvas>
						</div>
					</div>
					<div>
						<div class="d-flex flex-column mb-1">
							<h4 class="mb-0">
								<span>Heatmap </span><svg data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Heatmap shows the number of games played during each hour of the event. Each row represents one calendar day." style="width: 0.9em; height: 0.9em;" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg>
							</h4>
							<span id="eventProfileTotalGamesLb" style="font-size: 0.9rem;" class="text-white-50"></span>
						</div>
						<svg id="heatmapContainer" viewBox="-3 0 780 128" xmlns="http://www.w3.org/2000/svg"></svg>
						<!-- <div id="heatmapPlaceholder" class="placeholder-glow" style="height: min(300px, 30vw);">
							<span class="placeholder w-100 h-100"></span>
						</div> -->
						<div class="d-flex mt-2">
							<div style="flex: 1;">
								<button id="copyHeatmapBtn" class="btn btn-secondary btn-sm">
									<svg style="vertical-align: -.125em" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-image" viewBox="0 0 16 16">
										<path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
										<path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1z"/>
									</svg>
									<span>Copy</span>
								</button>
							</div>
							<div class="d-flex gap-2 justify-content-center mt-1">
								<label class="form-check-label" for="heatmapTimezoneCb">EST (NeneRobo)</label>
								<div class="form-check form-switch">
									<input class="form-check-input" type="checkbox" role="switch" id="heatmapTimezoneCb">
									<label class="form-check-label" for="heatmapTimezoneCb">Local timezone</label>
								</div>
							</div>
							<div style="flex: 1;"></div>
						</div>
					</div>
					<div>
						<h4>Points Graph</h4>
						<canvas id="pointsGraph"></canvas>
					</div>
					<hr>
					<div class="d-flex justify-content-center">
						<p>This feature is in beta. Report any bugs or wrong data to amia (the person, not the bot).</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<footer class="py-3">
		<span>Contact: <a id="contactBtn" href="javascript:void(0)" data-bs-toggle="modal" data-bs-target="#contactModal">Show</a></span>
	</footer>

	<script>
		document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(x => new bootstrap.Tooltip(x))
	
		function switchTab(idx) {
			const button = document.querySelector(`#chapterTabs .nav-item:nth-child(${idx + 1}) button`)
			const eventTableCard = document.getElementById("eventTableCard")

			bootstrap.Tab.getInstance(button).show()
			eventTableCard.style.setProperty("background-color", button.style.getPropertyValue("--bs-nav-tabs-link-active-bg"))

			if(idx === 0) {
				eventTableCard.style.setProperty("border-top-left-radius", "0")
			} else {
				eventTableCard.style.removeProperty("border-top-left-radius")
			}

			localStorage.setItem("tabIdx", idx.toString())
		}

		document.querySelectorAll("#chapterTabs button").forEach((x, idx) => {
			const tabTrigger = new bootstrap.Tab(x)
			x.addEventListener("click", event => {
				event.preventDefault()
				switchTab(idx)
			})
		})

		// https://stackoverflow.com/a/13542669
		const pSBC=(p,c0,c1,l)=>{
			let r,g,b,P,f,t,h,i=parseInt,m=Math.round,a=typeof(c1)=="string";
			if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
			if(!this.pSBCr)this.pSBCr=(d)=>{
				let n=d.length,x={};
				if(n>9){
					[r,g,b,a]=d=d.split(","),n=d.length;
					if(n<3||n>4)return null;
					x.r=i(r[3]=="a"?r.slice(5):r.slice(4)),x.g=i(g),x.b=i(b),x.a=a?parseFloat(a):-1
				}else{
					if(n==8||n==6||n<4)return null;
					if(n<6)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
					d=i(d.slice(1),16);
					if(n==9||n==5)x.r=d>>24&255,x.g=d>>16&255,x.b=d>>8&255,x.a=m((d&255)/0.255)/1000;
					else x.r=d>>16,x.g=d>>8&255,x.b=d&255,x.a=-1
				}return x};
			h=c0.length>9,h=a?c1.length>9?true:c1=="c"?!h:false:h,f=this.pSBCr(c0),P=p<0,t=c1&&c1!="c"?this.pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},p=P?p*-1:p,P=1-p;
			if(!f||!t)return null;
			if(l)r=m(P*f.r+p*t.r),g=m(P*f.g+p*t.g),b=m(P*f.b+p*t.b);
			else r=m((P*f.r**2+p*t.r**2)**0.5),g=m((P*f.g**2+p*t.g**2)**0.5),b=m((P*f.b**2+p*t.b**2)**0.5);
			a=f.a,t=t.a,f=a>=0||t>=0,a=f?a<0?t:t<0?a:a*P+t*p:0;
			if(h)return"rgb"+(f?"a(":"(")+r+","+g+","+b+(f?","+m(a*1000)/1000:"")+")";
			else return"#"+(4294967296+r*16777216+g*65536+b*256+(f?m(a*255):0)).toString(16).slice(1,f?undefined:-2)
		}

		function formatNumber(num) {
			return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
		}

		function removeTMPTags(name) {
			return name.replace(/[<‹]\/?(?:#|a|align|allcaps|alpha|b|color|cspace|font|font-weight|gradient|i|indent|line-height|line-indent|link|lowercase|margin|mark|mspace|nobr|noparse|page|pos|rotate|s|size|smallcaps|space|sprite|style|sub|sup|u|uppercase|voffset|width).*?[>›]/gi, "")
		}

		let lastUpdatedAt
		function toggleIssuesBanner(toggled, msg) {
			const banner = document.getElementById("issuesBanner")
			const label = document.getElementById("issuesBannerLabel")

			if(toggled) {
				label.innerText = msg + `\nLast update: ${lastUpdatedAt?.toLocaleTimeString() ?? "N/A"}`
				banner.style.display = ""
			} else {
				banner.style.display = "none"
			}
		}

		function toggleFailureMessage(toggled) {
			const rankingContainer = document.getElementById("rankingContainer")
			const logoContainer = document.getElementById("logoContainer")
			const logoPlaceholder = document.getElementById("eventCountdownPlaceholder")
			const errorMsg = document.getElementById("errorMsg")

			if(toggled) {
				rankingContainer.style.setProperty("display", "none", "important")
				logoContainer.style.setProperty("display", "none", "important")
				logoPlaceholder.style.setProperty("display", "none", "important")
				errorMsg.style.display = ""
			} else {
				rankingContainer.style.display = logoContainer.style.display = ""
				errorMsg.style.display = "none"
			}
		}

		function toggleMaintenanceBanner(toggled, data) {
			if(toggled) {
				const startsAt = new Date(data.starts_at)
				const endsAt = new Date(data.ends_at)

				const startsAtStr = startsAt.toLocaleTimeString(undefined, {hour: "numeric", minute: "numeric"})
				const endsAtStr = endsAt.toLocaleTimeString(undefined, {hour: "numeric", minute: "numeric"})

				const countdownStr = startsAt.getTime() - Date.now() < 60 * 1000 ? "less than a minute" : countdown(null, startsAt, countdown.HOURS | countdown.MINUTES).toString()

				document.getElementById("gameMaintenanceBanner").style.display = ""
				document.getElementById("gameMaintenanceBannerLabel").innerText = `Project Sekai maintenance is scheduled to take place in ${countdownStr}!\nMaintenance period: ${startsAtStr} - ${endsAtStr} local time`

				if(data.news_id) {
					document.getElementById("gameMaintenanceBannerNewsLink").style.display = ""
					document.getElementById("gameMaintenanceBannerNewsLink").href = `https://n-production-web.sekai-en.com/information/index.html?id=${data.news_id}`
				} else {
					document.getElementById("gameMaintenanceBannerNewsLink").style.display = "none"
				}
			} else {
				document.getElementById("gameMaintenanceBanner").style.display = "none"
			}
		}

		async function getServerTime() {
			const res = await fetch("/api/time")
			if(!res.ok) {
				throw new Error("getServerTime() failed: " + res.status)
			}

			const json = await res.json()
			return json.server_time
		}

		async function getLeaderboard(noCache) {
			try {
				const res = await fetch("/api/leaderboard" + (noCache ? "?nocache=true" : ""))
				if(!res.ok) {
					console.error("getLeaderboard() failed (1):", res.status)

					if(res.headers.get("cf-mitigated") === "challenge") {
						return {errorType: "challenge"}
					}
					return {errorType: "backend"}
				}

				const json = await res.json()
				return {data: json}
			} catch(ex) {
				console.error("getLeaderboard() failed (2):", ex)
				return {errorType: "network"}
			}
		}

		async function getAnnouncements() {
			const res = await fetch("/api/cc-announcements")
			if(!res.ok) {
				throw new Error("getAnnouncements() failed: " + res.status)
			}

			const json = await res.json()
			return json
		}

		async function getUserEventProfile(hash, abortSignal) {
			const res = await fetch(`/api/event-profiles/${hash}`, {signal: abortSignal})
			if(!res.ok) {
				throw new Error("getUserEventProfile() failed: " + res.status)
			}

			const json = await res.json()
			return json
		}

		async function getUserEventStats(hash, chapter, abortSignal) {
			const res = await fetch(`/api/event-stats/${hash}${chapter != null ? `?chapter=${chapter}` : ""}`, {signal: abortSignal})
			if(!res.ok) {
				throw new Error("getUserEventStats() failed: " + res.status)
			}

			const json = await res.json()
			return json
		}

		async function getCutoffStats(cutoff, chapter, abortSignal) {
			const res = await fetch(`/api/events/now/cutoff-stats/${cutoff}${chapter != null ? `?chapter=${chapter}` : ""}`, {signal: abortSignal})
			if(!res.ok) {
				throw new Error("getCutoffStats() failed: " + res.status)
			}

			const json = await res.json()
			return json
		}

		async function getGameMaintenance() {
			const res = await fetch("/api/game/maintenance")
			if(!res.ok) {
				throw new Error("getGameMaintenance() failed: " + res.status)
			}

			const json = await res.json()
			return json
		}

		const announceQueue = []
		let announceDebounce = false
		function queueAnnouncement(message) {
			announceQueue.push(message)
			announcementLoop()
		}

		// the only way to restart a css animation is to remove the css, cause reflow, re-add the css
		// https://stackoverflow.com/a/45036752
		// love html xoxo
		function announcementLoop() {
			if(!announceDebounce && announceQueue.length > 0) {
				announceDebounce = true
				document.getElementById("announcementBanner").style.animationName = "fade-in-anim"
				document.getElementById("announcementBanner").style.display = ""
				document.getElementById("announcementMessageContainer").classList.add("scrolling-animation-container")
				document.getElementById("announcementMessage").style.display = ""
				document.getElementById("announcementMessage").innerText = announceQueue.shift()
			}
		}
		announcementMessageContainer.addEventListener("animationend", event => {
			announceDebounce = false

			document.getElementById("announcementMessage").style.display = "none"
			document.getElementById("announcementBanner").style.animationName = "fade-out-anim"
		})
		announcementBanner.addEventListener("animationend", event => {
			if(event.animationName !== "fade-out-anim") {
				return
			}

			document.getElementById("announcementBanner").style.display = "none"
			document.getElementById("announcementMessageContainer").classList.remove("scrolling-animation-container")
			document.getElementById("announcementMessageContainer").offsetHeight

			announcementLoop()
		})

		let currentEvent
		let timerStarted = false
		let nextTimerStarted = false
		let lastLbUpdate
		let lastMaintCheck
		let lastMaintRes
		let trackHash = localStorage.getItem("trackHash")
		let clockOffset = 0

		async function doUpdate() {
			if(lastLbUpdate && document.visibilityState === "hidden") {
				return
			}

			// Check for game maintenances
			if(!lastMaintCheck || (Date.now() - lastMaintCheck.getTime() >= 10 * 60 * 1000)) {
				lastMaintRes = await getGameMaintenance()
				lastMaintCheck = new Date()
			}

			if(document.getElementById("gameMaintenanceBanner") != null) { // If banner wasn't dismissed
				const next = lastMaintRes.planned_maintenances.find(x => {
					const startsAt = new Date(x.starts_at).getTime()
					return startsAt > Date.now() && (startsAt - Date.now() < 4 * 3600 * 1000)
				})
				if(next) {
					toggleMaintenanceBanner(true, next)
				} else {
					toggleMaintenanceBanner(false)
				}
			}

			const {data, errorType} = await getLeaderboard(!timerStarted)
			if(!data) {
				if(errorType === "challenge") {
					return document.location.reload()
				}

				if(!lastLbUpdate) {
					toggleFailureMessage(true)
				} else {
					let msg = "An unknown error has occurred."

					switch(errorType) {
						case "backend":
							msg = "We're experiencing issues. The leaderboard might not be up to date!"
							break
						case "network":
							msg = "Your network is offline. The leaderboard cannot update!"
							break
					}

					toggleIssuesBanner(true, msg)
				}
				return
			}
			if(!data.event) { // Backend restarting
				return
			}
			lastUpdatedAt = data.updated_at && new Date(data.updated_at)
			
			toggleFailureMessage(false)
			if(data.aggregate_until) {
				toggleIssuesBanner(true, `The leaderboard is calculating until ${new Date(data.aggregate_until).toLocaleTimeString()}!`)
			} else if(data.update_error) {
				let msg = "An unknown error has occurred."

				switch(data.update_error) {
					case "maintenance":
						if(lastMaintRes.active_maintenance) {
							const startTimeStr = new Date(lastMaintRes.active_maintenance.starts_at).toLocaleTimeString(undefined, {hour: "numeric", minute: "numeric"})
							const endTimeStr = new Date(lastMaintRes.active_maintenance.ends_at).toLocaleTimeString(undefined, {hour: "numeric", minute: "numeric"})
							msg = `Project Sekai is under maintenance. The leaderboard cannot update!\nMaintenance period: ${startTimeStr} - ${endTimeStr} local time.`
						} else {
							msg = "Project Sekai is under maintenance. The leaderboard cannot update!"
						}
						break
				}

				toggleIssuesBanner(true, msg)
			} else if(lastUpdatedAt && (Date.now() - lastUpdatedAt.getTime() > 3 * 60 * 1000)) {
				toggleIssuesBanner(true, "We're experiencing issues. The leaderboard might not be up to date!")
			} else {
				toggleIssuesBanner(false)
			}
			
			const eventData = currentEvent = data.event
			document.getElementById("eventLogoPlaceholder").style.display = "none"
			document.getElementById("eventLogo").src = `assets/${eventData.name_key}.png`
			document.getElementById("eventLogo").alt = `${eventData.name} event logo`
			document.getElementById("eventLogo").style.display = ""
			if(eventData.chapter_character) {
				document.getElementById("eventChapterCharacter").style.display = ""
				document.getElementById("eventChapterCharacter").src = `assets/character_${eventData.chapter_character}.png`

				const characterName = eventData.chapters.find(x => x.num === eventData.chapter_num)?.title
				if(characterName) {
					document.getElementById("eventChapterCharacter").alt = `${characterName} icon`
				} else {
					document.getElementById("eventChapterCharacter").alt = "Worldlink chapter character icon"
				}
			} else {
				document.getElementById("eventChapterCharacter").style.display = "none"
			}
			if(eventData.ends_at && !timerStarted) {
				timerStarted = true

				const reqStart = Date.now()
				let serverTime = await getServerTime()
				const reqEnd = Date.now()

				serverTime = serverTime + (reqEnd - reqStart)
				clockOffset = Date.now() - serverTime
				console.log("Clock offset:", clockOffset)

				document.getElementById("eventCountdownPlaceholder").style.display = "none"
				document.getElementById("eventCountdown").style.display = ""
				
				const eventEndsAt = new Date(eventData.ends_at)
				const flipdown = new FlipDown(Math.floor((eventEndsAt.getTime() + clockOffset)/1000), "eventCountdownClock", {theme: "light"})
				flipdown.start()
			}
			if(eventData.titles_at && !eventData.chapter_num && new Date(eventData.ends_at).getTime() < Date.now() && new Date(eventData.titles_at).getTime() > Date.now()) {
				document.getElementById("eventInfoMsg").style.display = ""
				document.getElementById("eventInfoMsg").innerText = `Event titles will be distributed in ${countdown(null, new Date(eventData.titles_at), countdown.HOURS | countdown.MINUTES).toString()}`
			} else {
				document.getElementById("eventInfoMsg").style.display = "none"
			}

			const nextEventData = data.next_event
			if(nextEventData) {
				document.getElementById("nextLogoContainer").classList.remove("d-none")
				document.getElementById("nextEventLogo").src = `assets/${nextEventData.name_key}.png`
				document.getElementById("nextEventLogo").alt = `${nextEventData.name} event logo`

				if(nextEventData.chapter_character) {
					document.getElementById("nextEventChapterCharacter").style.display = ""
					document.getElementById("nextEventChapterCharacter").src = `assets/character_${nextEventData.chapter_character}.png`
				}

				if(nextEventData.starts_at && !nextTimerStarted) {
					nextTimerStarted = true
					document.getElementById("nextEventCountdown").classList.remove("d-none")
					
					const eventStartsAt = new Date(nextEventData.starts_at)
					const flipdown = new FlipDown(Math.floor((eventStartsAt.getTime() + clockOffset)/1000), "nextEventCountdownClock", {theme: "light"})
					flipdown.start()
				}

				document.getElementById("eventSeparator").classList.remove("d-none")
			} else {
				document.getElementById("nextLogoContainer").classList.add("d-none")
				document.getElementById("nextEventCountdown").classList.add("d-none")
				document.getElementById("eventSeparator").classList.add("d-none")
			}

			const showHighlights = document.getElementById("showBordersCb").checked
			if(showHighlights) {
				document.querySelectorAll(".past-hour-col").forEach(x => x.style.display = "none")
				document.querySelectorAll(".per-game-col").forEach(x => x.style.display = "none")
				document.querySelectorAll(".past-hour-by-rank-col").forEach(x => x.style.display = "")
			} else {
				document.querySelectorAll(".past-hour-col").forEach(x => x.style.display = "")
				document.querySelectorAll(".per-game-col").forEach(x => x.style.display = "")
				document.querySelectorAll(".past-hour-by-rank-col").forEach(x => x.style.display = "none")
			}
			updateLeaderboard(document.getElementById("eventTableOverall"), showHighlights ? data.borders : data.rankings)

			if(data.chapter_rankings) {
				document.getElementById("chapterTabs").style.removeProperty("display")
				document.getElementById("eventTableCard").style.setProperty("border-top-left-radius", "0")
				
				for(const chapter of data.event.chapters) {
					const color = pSBC(0.7, chapter.color)
					const hoverColor = pSBC(0.5, chapter.color)
					const button = document.getElementById(`chapter-${chapter.num}-tab`)
					button.innerText = chapter.title
					button.style.setProperty("--bs-nav-tabs-link-active-bg", color)
					button.style.display = ""
					
					const tbl = document.getElementById("eventTableChapter" + chapter.num)
					tbl.style.setProperty("--bs-table-bg", color)
					tbl.style.setProperty("--bs-table-hover-bg", hoverColor)

					const chapterStart = new Date(chapter.starts_at)
					if(chapterStart.getTime() > Date.now()) {
						tbl.style.display = "none"
						document.getElementById(`eventTableChapter${chapter.num}Countdown`).style.display = ""
						document.getElementById(`eventTableChapter${chapter.num}CountdownLabel`).innerText = chapterStart.toLocaleString()
					} else {
						tbl.style.display = ""
					}
				}
				
				for(const [idx, rankings] of (showHighlights ? data.chapter_borders : data.chapter_rankings).entries()) {
					const chapterNum = idx + 1
					updateLeaderboard(document.getElementById("eventTableChapter" + chapterNum), rankings, chapterNum)
				}

				if(!lastLbUpdate) {
					const idx = localStorage.getItem("tabIdx") ?? data.event.chapters.find(x => x.current)?.num
					if(idx) {
						switchTab(+idx)
					}
				}
			}

			if(eventData.type === "cheerful_carnival") {
				try {
					const res = await getAnnouncements()

					if(res.team_stats.length > 0 && !document.getElementById("compactModeCb").checked) {
						document.getElementById("ccTeamsContainer").classList.remove("d-none")
						for(const [idx, teamStats] of res.team_stats.entries()) {
							document.getElementById(`ccTeam${idx + 1}Img`).src = `/assets/team_${teamStats.team_id}.png`
							document.getElementById(`ccTeam${idx + 1}Bonus`).textContent = formatNumber(teamStats.total_bonus) + " Bonus"

							if(teamStats.midterm) {
								document.getElementById(`ccTeam${idx + 1}MidtermContainer`).style.display = ""
								document.getElementById(`ccTeam${idx + 1}MidtermLabel`).textContent = `Term ${teamStats.midterm.seq}:`
								document.getElementById(`ccTeam${idx + 1}MidtermPoints`).textContent = formatNumber(teamStats.midterm.points)
							}
						}
					} else {
						document.getElementById("ccTeamsContainer").classList.add("d-none")
					}

					const isEnabled = document.getElementById("showCCAnnounceCb").checked
					const isFresh = Date.now() - new Date(res.updated_at).getTime() <= 2 * 60 * 1000 && res.updated_at !== localStorage.getItem("lastCCAnnounce")
					if(isEnabled && isFresh && res.announcements.length > 0) {
						localStorage.setItem("lastCCAnnounce", res.updated_at)
						
						for(const message of res.announcements) {
							queueAnnouncement(message)
						}
					}
				} catch(ex) {
					console.error(ex)
				}
			} else {
				document.getElementById("ccTeamsContainer").classList.add("d-none")
			}

			lastLbUpdate = new Date()
		}

		function updateLeaderboard(table, rankings, chapter) {
			const isBordersView = document.getElementById("showBordersCb").checked
			const tableBody = table.querySelector("tbody")
			while(tableBody.firstChild) {
				tableBody.removeChild(tableBody.lastChild)
			}

			let scrollTo
			for(const slot of rankings) {
				const tableRow = document.createElement("tr")

				const rankCell = document.createElement("td")
				const nameCell = document.createElement("td")
				const nameCellDiv = document.createElement("div")
				const pointsCell = document.createElement("td")
				const deltaCell = document.createElement("td")
				const avgCell = document.createElement("td")

				rankCell.style.verticalAlign = "middle"
				nameCell.style.verticalAlign = "middle"
				pointsCell.style.verticalAlign = "middle"
				deltaCell.style.verticalAlign = "middle"
				avgCell.style.verticalAlign = "middle"

				rankCell.setAttribute("scope", "row")
				if([1,2,3].includes(slot.rank)) {
					rankCell.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-crown w-6 h-6 text-yellow-400"><path d="M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z"></path><path d="M5 21h14"></path></svg>`
					rankCell.ariaLabel = slot.rank.toString()
				} else {
					rankCell.innerText = formatNumber(slot.rank)
				}

				nameCellDiv.setAttribute("class", "d-flex align-items-center gap-2 username-cell")

				if(!document.getElementById("compactModeCb").checked) {
					nameCell.style.paddingTop = "5px"
					nameCell.style.paddingBottom = "5px"

					const leaderImg = document.createElement("img")
					leaderImg.src = `/images/card/leader/${slot.card.id}.png?level=${slot.card.level}&mastery=${slot.card.mastery}&trained=${slot.card.trained}&image=${slot.card.image}`
					leaderImg.width = 38
					leaderImg.height = 38
					leaderImg.alt = "Leader Card"

					if(slot.hash) {
						leaderImg.classList.add("avatar-clickable")
						leaderImg.addEventListener("click", async function(event) {
							event.preventDefault()
							event.stopPropagation()
							new bootstrap.Modal("#eventProfileModal").show()
							loadEventProfileModal(slot.hash, slot.rank, chapter)
						})
					}

					nameCellDiv.appendChild(leaderImg)
				}

				if(slot.team != null) {
					const teamImg = document.createElement("img")
					teamImg.src = `/assets/team_${slot.team}.png`
					teamImg.width = 20
					teamImg.height = 20
					teamImg.alt = "Team logo"

					nameCellDiv.appendChild(teamImg)
				}
				const nameLabel = document.createElement("span")
				nameLabel.setAttribute("class", "username-label")
				nameLabel.textContent = nameLabel.title = removeTMPTags(slot.name)

				if(slot.hash) {
					nameLabel.classList.add("username-clickable")
					nameLabel.addEventListener("click", async function(event) {
						event.preventDefault()
						event.stopPropagation()
						new bootstrap.Modal("#eventProfileModal").show()
						loadEventProfileModal(slot.hash, slot.rank, chapter)
					})
				}
				nameCellDiv.appendChild(nameLabel)
				nameCell.appendChild(nameCellDiv)

				pointsCell.innerText = formatNumber(slot.score)
				if(isBordersView) {
					deltaCell.innerText = !!slot.rank_delta ? "+" + formatNumber(slot.rank_delta) : "-"
				} else {
					deltaCell.innerText = !!slot.delta ? "+" + formatNumber(slot.delta) : "-"
				}
				avgCell.innerText = !!slot.average ? "+" + formatNumber(Math.floor(slot.average)) : "-"

				if(chapter == null && [3, 10, 50].includes(slot.rank - 1)) {
					tableRow.classList.add("class", "table-group-divider")
				}
				if(trackHash === slot.hash && !isBordersView) {
					tableRow.classList.add("table-row-tracked")
					scrollTo = tableRow
				}

				rankCell.setAttribute("class", "fw-bold text-center")
				switch(slot.rank) {
					case 1:
						rankCell.style.color = "#facc15"
						break
					case 2:
						rankCell.style.color = "#9ca3af"
						break
					case 3:
						rankCell.style.color = "#d97706"
						break
					default:
						rankCell.style.color = "#00ccbb"
						break
				}
				pointsCell.style.color = "#ff55ab"

				tableRow.appendChild(rankCell)
				tableRow.appendChild(nameCell)
				tableRow.appendChild(pointsCell)
				tableRow.appendChild(deltaCell)
				if(!isBordersView) {
					tableRow.appendChild(avgCell)
				}

				tableBody.appendChild(tableRow)

				tableRow.addEventListener("click", function() {
					if(isBordersView) {
						return
					}

					if(trackHash === slot.hash) {
						trackHash = null
						localStorage.removeItem("trackHash")
						this.classList.remove("table-row-tracked")
					} else {
						trackHash = slot.hash
						localStorage.setItem("trackHash", slot.hash)
						document.querySelector(".table-row-tracked")?.classList?.remove("table-row-tracked")
						this.classList.add("table-row-tracked")
					}
				})
			}

			if(scrollTo) {
				scrollTo.scrollIntoView({behavior: "smooth", block: "center"})
			}
		}

		let lastCharts = []
		let profileModalAbort
		async function loadEventProfileModal(hash, cutoff, chapter) {
			// Clear old values
			eventProfileDeck.innerHTML = ""
			document.getElementById("eventProfileTalentDetails").open = false
			document.getElementById("eventProfileModalLabel").textContent = "..."
			document.getElementById("eventProfileTalentLb").textContent = ""
			document.getElementById("eventProfileBaseTalentLb").textContent = "Base Talent:"
			document.getElementById("eventProfileItemTalentLb").textContent = "Decoration Bonus:"
			document.getElementById("eventProfileCRTalentLb").textContent = "Character Rank Bonus:"
			document.getElementById("eventProfileTitleTalentLb").textContent = "Title Bonus:"
			document.getElementById("eventProfileBonusLb").textContent = ""
			lastCharts.forEach(x => {
				x.clear()
				x.destroy()
			})
			lastCharts = []
			if(profileModalAbort) {
				profileModalAbort.abort()
			}
			profileModalAbort = new AbortController()
			document.getElementById("eventProfileTotalGamesLb").textContent = ""
			document.getElementById("heatmapContainer").innerHTML = ""
			// document.getElementById("heatmapPlaceholder").style.display = ""

			if(localStorage.getItem("heatmapTimezone") === "true") {
				document.getElementById("heatmapTimezoneCb").checked = true
			}

			const profile = await getUserEventProfile(hash, profileModalAbort.signal)
			const statsPromise = getUserEventStats(hash, chapter, profileModalAbort.signal)
			const cutoffPromise = getCutoffStats(cutoff, chapter, profileModalAbort.signal)

			// Render name
			document.getElementById("eventProfileModalLabel").textContent = removeTMPTags(profile.name)

			// Render cards
			for(const [idx, card] of profile.cards.entries()) {
				const img = document.createElement("img")
				img.style.minWidth = "80px"
				img.style.width = "100%"
				img.style.maxWidth = "128px"
				img.src = `/images/card/deck/${card.id}.png?level=${card.level}&mastery=${card.mastery}&trained=${card.trained}&image=${card.image}&slot=${idx}`
				img.alt = img.title = card.description

				const a = document.createElement("a")
				a.href = `https://sekai.best/card/${card.id}`
				a.target = "_blank"
				a.appendChild(img)

				const div = document.createElement("div")
				div.style.aspectRatio = "312/510"
				div.style.maxWidth = "20%"
				div.appendChild(a)

				document.getElementById("eventProfileDeck").appendChild(div)
			}

			// Render talent
			document.getElementById("eventProfileTalentLb").textContent = formatNumber(profile.talent.total_talent)
			document.getElementById("eventProfileBaseTalentLb").textContent = `Base Talent: ${formatNumber(profile.talent.basic_talent)}`
			document.getElementById("eventProfileItemTalentLb").textContent = `Decoration Bonus: ${formatNumber(profile.talent.area_item_bonus)}`
			document.getElementById("eventProfileCRTalentLb").textContent = `Character Rank Bonus: ${formatNumber(profile.talent.character_rank_bonus)}`
			document.getElementById("eventProfileTitleTalentLb").textContent = `Title Bonus: ${formatNumber(profile.talent.honor_bonus)}`

			// Render event bonus
			document.getElementById("eventProfileBonusLb").textContent = profile.event_bonus != null ? `${profile.event_bonus}%` : "¯\\_(ツ)_/¯"

			const stats = await statsPromise
			stats.timeline.forEach(x => x.timestamp = new Date(x.timestamp))
			const deltaTimeline = []
			for(const [idx, val] of stats.timeline.entries()) {
				if(idx === 0 || stats.timeline[idx-1].score !== val.score) {
					deltaTimeline.push(val)
				}
			}

			// Render recent games
			const hourAgo = new Date(Date.now() - 3600 * 1000)
			const recentGames = []
			for(const [idx, dataPoint] of deltaTimeline.entries()) {
				if(dataPoint.timestamp >= hourAgo && (recentGames.length === 0 || (deltaTimeline[idx-1]?.score || 0) < dataPoint.score)) {
					recentGames.push({
						timestamp: dataPoint.timestamp,
						delta: dataPoint.score - (deltaTimeline[idx-1]?.score || 0)
					})
				}
			}

			lastCharts.push(new Chart(document.getElementById("recentGamesChart"), {
				type: "scatter",
				data: {
					labels: [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55, 60],
					datasets: [{
						data: recentGames.map(x => ({
							x: Math.floor((x.timestamp.getTime() - hourAgo.getTime())/1000/60),
							y: 1
						}))
					}]
				},
				options: {
					interaction: {
						intersect: false,
						mode: "nearest",
						axis: "x"
					},
					maintainAspectRatio: false,
					animation: false,
					scales: {
						x: {
							min: 0,
							max: 60,
							grid: {
								display: false
							},
							ticks: {
								callback: function(value, index, values) {
									if(value === 60) {
										return "Now"
									}
									return new Date(hourAgo.getTime() + value * 60 * 1000).toLocaleTimeString(undefined, {hour: "numeric", minute: "numeric"})
								}
							}
						},
						y: {
							min: 0,
							max: 2,
							grid: {
								display: false
							},
							ticks: {
								display: false
							}
						}
					},
					plugins: {
						legend: {
							display: false
						},
						tooltip: {
							callbacks: {
								title: (data) => `${data.length} game${data.length !== 1 ? "s" : ""} played`,
								label: (data) => `+${formatNumber(recentGames[data.dataIndex].delta)} points`,
								// afterLabel: (data) => `at ${recentGames[data.dataIndex].timestamp.toLocaleTimeString()}`
							}
						}
					}
				}
			}))

			// Render heatmap
			const startDate = chapter != null ? currentEvent.chapters.find(x => x.num === chapter).starts_at : currentEvent.starts_at
			const endDate = chapter != null ? currentEvent.chapters.find(x => x.num === chapter).ends_at : currentEvent.ends_at
			document.getElementById("eventProfileTotalGamesLb").textContent = `${deltaTimeline.length} total games`
			document.getElementById("heatmapTimezoneCb").onchange = function() {
				if(this.checked) {
					renderHeatmap(new Date(startDate), new Date(endDate), new Date().getTimezoneOffset()/60, deltaTimeline)
				} else {
					renderHeatmap(new Date(startDate), new Date(endDate), 4, deltaTimeline)
				}

				localStorage.setItem("heatmapTimezone", this.checked.toString())
			}
			if(localStorage.getItem("heatmapTimezone") === "true") {
				renderHeatmap(new Date(startDate), new Date(endDate), new Date().getTimezoneOffset()/60, deltaTimeline)
			} else {
				renderHeatmap(new Date(startDate), new Date(endDate), 4, deltaTimeline)
			}

			const cutoffStats = await cutoffPromise
			cutoffStats.timeline.forEach(x => x.timestamp = new Date(x.timestamp))

			document.getElementById("copyHeatmapBtn").onclick = async function() {
				const title = `T${cutoff} ${currentEvent.name}${chapter != null ? `, Chapter ${chapter}` : ""}`
				const subtitle = `${deltaTimeline.length} total games`
				const leaderCard = profile.cards[0]
				const iconUrl = `/images/card/leader/${leaderCard.id}.png?level=${leaderCard.level}&mastery=${leaderCard.mastery}&trained=${leaderCard.trained}&image=${leaderCard.image}`

				await copyHeatmap(title, subtitle, profile.name, iconUrl)

				const span = this.querySelector("span")
				const currentText = span.textContent
				span.textContent = "Copied!"
				setTimeout(() => span.textContent = currentText, 2000)
			}

			// Render points graph
			const recentGamesByDelta = []
			const cutoffByDelta = []
			stats.timeline.map(x => ({
				x: Math.floor((x.timestamp.getTime() - new Date(startDate).getTime())/60000),
				y: x.score
			})).forEach(entry => {
				if(recentGamesByDelta.length === 0 || recentGamesByDelta.at(-1).x !== entry.x) {
					recentGamesByDelta.push(entry)
				}
			})
			cutoffStats.timeline.map(x => ({
				x: Math.floor((x.timestamp.getTime() - new Date(startDate).getTime())/60000),
				y: x.score
			})).forEach(entry => {
				if(cutoffByDelta.length === 0 || cutoffByDelta.at(-1).x !== entry.x) {
					cutoffByDelta.push(entry)
				}
			})
			const minX = 0
			const maxX = Math.max(...recentGamesByDelta.map(x => x.x))
			const step = 1
			const labels = []
			for(let i=minX;i<=maxX;i+=step) {
				labels.push(i)
			}

			for(const [idx, val] of labels.entries()) {
				if(!recentGamesByDelta[idx] || recentGamesByDelta[idx].x !== val) {
					recentGamesByDelta.splice(idx, 0, {x: val, y: null})
				}
				if(!cutoffByDelta[idx] || cutoffByDelta[idx].x !== val) {
					cutoffByDelta.splice(idx, 0, {x: val, y: null})
				}
			}

			lastCharts.push(new Chart(document.getElementById("pointsGraph"), {
				type: "line",
				data: {
					labels: labels,
					datasets: [
						{
							label: removeTMPTags(profile.name),
							data: recentGamesByDelta.map(x => x.y),
							spanGaps: true,
							pointRadius: 0,
							segment: {
								borderDash: ctx => {
									if(!ctx.p0.skip && !ctx.p1.skip) {
										return
									}

									// ctx only provides the two points compared, including the dummy y: null ones,
									// so we have to do the math ourselves
									const start = recentGamesByDelta.findLastIndex((val, idx) => idx <= ctx.p0DataIndex && val.y != null)
									const end = recentGamesByDelta.findIndex((val, idx) => idx >= ctx.p0DataIndex && val.y != null)
									const diff = end - start
									if(diff > 30) {
										return [6,6]
									}
								}
							}
						},
						{
							label: `T${cutoff} Cutoff`,
							data: cutoffByDelta.map(x => x.y),
							spanGaps: true,
							pointRadius: 0
						}
					]
				},
				options: {
					interaction: {
						intersect: false,
						mode: "nearest",
						axis: "x"
					},
					aspectRatio: Math.max(1, window.screen.availWidth/window.screen.availHeight),
					scales: {
						x: {
							title: {
								display: true,
								text: "Event Time"
							},
							ticks: {
								callback: function(value, index, values) {
									const val = parseInt(this.getLabelForValue(value))
									if(val % 60 === 0) {
										if(val % 1440 === 0 && val > 0) {
											return `${val/1440}d`
										} else if(val >= 1440) {
											const days = Math.floor(val/1440)
											const minutes = val%1440
											return `${days}d ${minutes/60}h`
										} else {
											return `${val/60}h`
										}
									} else if(val % 5 === 0) {
										const hours = Math.floor(val/60)
										const minutes = val%60
										if(hours > 0) {
											return `${hours}h ${minutes}min`
										} else {
											return `${minutes} min`
										}
									}
								}
							}
						},
						y: {
							title: {
								display: true,
								text: "Event Points"
							}
						}
					},
					plugins: {
						tooltip: {
							callbacks: {
								title: function(tooltipItem, data) {
									let val = parseInt(tooltipItem[0].label)
									const days = Math.floor(val/1440)
									val %= 1440
									const hours = Math.floor(val/60)
									val %= 60
									const minutes = val

									const parts = []
									if(days) {
										parts.push(`${days} days`)
									}
									if(hours) {
										parts.push(`${hours} hours`)
									}
									if(minutes) {
										parts.push(`${minutes} minutes`)
									}
									
									return parts.join(", ")
								}
							}
						}
					}
				}
			}))
		}

		function shiftTimestampByTimezone(timestamp, tzOffset) {
			return timestamp - tzOffset * 3600 * 1000 + new Date().getTimezoneOffset() * 60 * 1000
		}

		function renderHeatmap(startDate, endDate, tzOffset, timeline) {
			document.getElementById("heatmapContainer").innerHTML = ""

			const BoxWidthHeight = 32
			const BoxStrokeSize = 2
			const HourLabelHeight = 15
			const HourLabelPadding = 3
			const XOffsetStart = -3
			const XOffsetEnd = 10

			const colors = ["#321b37", "#3b2142", "#45284e", "#4e2e5a", "#563465", "#5e3b70", "#65417b", "#6c4786", "#724e92", "#78549e", "#7d5baa", "#7a65b5", "#7072bd", "#637fc1", "#558cc2", "#5095c2", "#599bc5", "#62a0c9", "#6ba6cc", "#74abd0", "#7eb0d3", "#8cb4d7", "#99b8d9", "#a4bcdb", "#afc0dd", "#b9c4de", "#c8c6e3", "#d7c8e5", "#e5cae4", "#f0cee0", "#fad3db"]
			const days = []
			const dt = new Date(startDate.getTime())
			dt.setHours(dt.getHours() - tzOffset + new Date().getTimezoneOffset()/60,0,0,0)
			dt.setHours(0)
			for(;dt<=new Date(shiftTimestampByTimezone(endDate.getTime(), tzOffset));dt.setDate(dt.getDate()+1)) {
				days.push(new Date(dt))
			}
			for(let i=0;i<=24;i++) {
				const text = document.createElementNS("http://www.w3.org/2000/svg", "text")
				text.setAttribute("x", (BoxWidthHeight * i).toString())
				text.setAttribute("y", HourLabelHeight.toString())
				text.setAttribute("text-anchor", "middle")
				text.setAttribute("font-size", "10px")
				text.setAttribute("line-height", HourLabelHeight + "px")
				text.setAttribute("fill", "rgba(255, 255, 255, 0.5)")
				text.setAttribute("dominant-baseline", "text-after-edge")
				text.textContent = i
				document.getElementById("heatmapContainer").appendChild(text)
			}

			const effectiveDays = days.filter(x => x.getTime() <= shiftTimestampByTimezone(Date.now(), tzOffset))
			document.getElementById("heatmapContainer").setAttribute("viewBox", `${XOffsetStart} 0 ${BoxWidthHeight * 24 + XOffsetEnd} ${BoxWidthHeight * effectiveDays.length + BoxStrokeSize + HourLabelHeight + HourLabelPadding}`)

			for(const [dayIdx, day] of days.entries()) {
				for(let i=0;i<24;i++) {
					const dateAt = new Date(day.getTime() + i * 3600 * 1000)
					const dateIn1h = new Date(day.getTime() + (i + 1) * 3600 * 1000)

					if(dateAt.getTime() > shiftTimestampByTimezone(Date.now(), tzOffset)) {
						continue
					}

					const g = document.createElementNS("http://www.w3.org/2000/svg", "g")
					const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect")
					rect.setAttribute("x", (BoxWidthHeight * i).toString())
					rect.setAttribute("y", (dayIdx * BoxWidthHeight + HourLabelHeight + HourLabelPadding).toString())
					rect.setAttribute("width", BoxWidthHeight.toString())
					rect.setAttribute("height", BoxWidthHeight.toString())
					rect.setAttribute("stroke", "black")
					rect.setAttribute("stroke-width", BoxStrokeSize.toString())
					const text = document.createElementNS("http://www.w3.org/2000/svg", "text")
					text.setAttribute("x", (BoxWidthHeight * i + BoxWidthHeight/2).toString())
					text.setAttribute("y", (dayIdx * BoxWidthHeight + HourLabelHeight + HourLabelPadding + BoxWidthHeight/2).toString())
					text.setAttribute("text-anchor", "middle")
					text.setAttribute("dominant-baseline", "central")
					if(dateAt.getTime() >= shiftTimestampByTimezone(startDate.getTime(), tzOffset) && dateAt.getTime() < shiftTimestampByTimezone(endDate.getTime(), tzOffset) && dateAt.getTime() <= shiftTimestampByTimezone(Date.now(), tzOffset)) {
						const amountOfGames = timeline.filter(x => shiftTimestampByTimezone(x.timestamp.getTime(), tzOffset) >= dateAt.getTime() && shiftTimestampByTimezone(x.timestamp.getTime(), tzOffset) < dateIn1h.getTime()).length
						text.textContent = amountOfGames
						rect.setAttribute("fill", colors[Math.min(amountOfGames, colors.length-1)])
						text.setAttribute("fill", amountOfGames === 0 ? "#ffffff": "#000000")
					} else {
						rect.setAttribute("fill", "transparent")
					}
					g.appendChild(rect)
					g.appendChild(text)
					document.getElementById("heatmapContainer").appendChild(g)
				}
			}

			// document.getElementById("heatmapPlaceholder").style.display = "none"
		}

		if(localStorage.getItem("showCCAnnounce") === "false") {
			document.getElementById("showCCAnnounceCb").checked = false
		}
		document.getElementById("showCCAnnounceCb").addEventListener("change", function(event) {
			localStorage.setItem("showCCAnnounce", this.checked.toString())
		})

		if(localStorage.getItem("compactMode") === "true") {
			document.getElementById("compactModeCb").checked = true
		}
		document.getElementById("compactModeCb").addEventListener("change", async function(event) {
			localStorage.setItem("compactMode", this.checked.toString())
			await doUpdate()
			this.scrollIntoView({behavior: "instant", block: "center"})
		})


		if(localStorage.getItem("showBorders") === "true") {
			document.getElementById("showBordersCb").checked = true
		}
		document.getElementById("showBordersCb").addEventListener("change", async function(event) {
			localStorage.setItem("showBorders", this.checked.toString())
			await doUpdate()
			this.scrollIntoView({behavior: "instant", block: "center"})
		})

		async function copyHeatmap(title, subtitle, playerName, iconUrl) {
			const scale = 2
			const paddingY = 5
			const titleHeight = 50

			const heatmapContainer = document.getElementById("heatmapContainer")
			const svgElement = heatmapContainer.cloneNode(true)
			svgElement.style.backgroundColor = "#212529"
			svgElement.style.fontFamily = getComputedStyle(heatmapContainer).fontFamily
			svgElement.setAttribute("viewBox", `${heatmapContainer.viewBox.baseVal.x} ${heatmapContainer.viewBox.baseVal.y - titleHeight - paddingY} ${heatmapContainer.viewBox.baseVal.width} ${heatmapContainer.viewBox.baseVal.height + titleHeight + paddingY*2}`)

			const titleLb = document.createElementNS("http://www.w3.org/2000/svg", "text")
			titleLb.setAttribute("x", (heatmapContainer.viewBox.baseVal.width/2).toString())
			titleLb.setAttribute("y", "-25")
			titleLb.setAttribute("text-anchor", "middle")
			titleLb.setAttribute("font-size", "24px")
			titleLb.setAttribute("fill", "#ffffff")
			titleLb.textContent = title
			svgElement.appendChild(titleLb)

			const subtitleLb = document.createElementNS("http://www.w3.org/2000/svg", "text")
			subtitleLb.setAttribute("x", (heatmapContainer.viewBox.baseVal.width/2).toString())
			subtitleLb.setAttribute("y", "-8")
			subtitleLb.setAttribute("text-anchor", "middle")
			subtitleLb.setAttribute("font-size", "14px")
			subtitleLb.setAttribute("fill", "rgba(255, 255, 255, 0.5)")
			subtitleLb.textContent = subtitle
			svgElement.appendChild(subtitleLb)

			const playerNameLb = document.createElementNS("http://www.w3.org/2000/svg", "text")
			playerNameLb.setAttribute("x", "35")
			playerNameLb.setAttribute("y", "-20")
			playerNameLb.setAttribute("font-size", "15px")
			playerNameLb.setAttribute("fill", "#ffffff")
			playerNameLb.textContent = playerName
			svgElement.appendChild(playerNameLb)

			// svg image href has to be set as base64 data string,
			// as normal url doesn't work outside of document body for some reason 
			const playerIconData = await fetch(iconUrl).then(res => res.blob())
			.then(blob => new Promise((resolve, reject) => {
				const reader = new FileReader()
				reader.onloadend = () => resolve(reader.result)
				reader.onerror = reject
				reader.readAsDataURL(blob)
			}))

			const playerIcon = document.createElementNS("http://www.w3.org/2000/svg", "image")
			playerIcon.setAttribute("x", "0")
			playerIcon.setAttribute("y", "-40")
			playerIcon.setAttribute("width", "30")
			playerIcon.setAttribute("height", "30")
			playerIcon.setAttribute("href", playerIconData)
			svgElement.appendChild(playerIcon)

			const bbox = heatmapContainer.getBBox()
			svgElement.setAttribute("width", bbox.width * scale)
			svgElement.setAttribute("height", (bbox.height + titleHeight + paddingY*2) * scale)

			const serializer = new XMLSerializer()
			const svgString = serializer.serializeToString(svgElement)
			const encodedData = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svgString)

			const image = new Image()
			const loadPromise = new Promise(resolve => {
				image.addEventListener("load", () => resolve())
			})
			image.src = encodedData
			await loadPromise

			const canvas = document.createElement("canvas")
			canvas.width = image.naturalWidth
			canvas.height = image.naturalHeight
			canvas.getContext("2d").drawImage(image, 0, 0)

			const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"))
			canvas.remove()

			const item = new ClipboardItem({"image/png": blob})
			navigator.clipboard.write([item])
		}

		doUpdate()
		setInterval(doUpdate, 20 * 1000)

		document.addEventListener("visibilitychange", async function() {
			if(!lastLbUpdate) return

			const secondsDiff = (Date.now() - lastLbUpdate.getTime())/1000
			if(document.visibilityState === "visible" && secondsDiff >= 20) {
				await doUpdate()
			}
		})

		document.getElementById("contactBtn").addEventListener("click", async function(event) {
			const contactBody = document.getElementById("contactModalBody")

			try {
				const res = await fetch("/api/contact")
				const data = await res.json()
				if(res.ok) {
					contactBody.innerHTML = data.contact_info
				} else if(data.error) {
					contactBody.innerHTML = ""

					const label = document.createElement("p")
					label.textContent = `Error: ${data.error}`
					contactBody.appendChild(label)
					
				} else {
					throw new Error("Failed to fetch")
				}
			} catch(ex) {
				contactBody.innerHTML = `<p>Failed to load. Please refresh and try again.</p>`
			}
		})
	</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark" class="h-100">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=0.7">
	<meta name="description" content="Event leaderboard tracker for Project Sekai">
	<title>seka.ing - Event Tracker</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link href="/assets/flipdown.min.css" rel="stylesheet">
	<style>
		.table-row-tracked {
			--bs-table-bg: #ffc0cb;
			--bs-table-hover-bg: #efafbb;
		}

		@media (max-width: 768px) {
			.username-label {
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			
			.username-cell {
				max-width: 18ch;
			}
		}

		.nav-link {
			--bs-nav-link-color: white;
			--bs-nav-link-hover-color: #d1d1d1;
		}
	</style>
</head>
<body class="d-flex flex-column justify-content-center align-items-center" style="min-height: 100%;">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script src="/assets/flipdown.min.js"></script>

	<div id="issuesBanner" style="display: none;" class="sticky-top w-100 py-3 bg-danger text-center rounded-bottom">
		<span id="issuesBannerLabel"></span>
	</div>

	<div id="nextLogoContainer" class="my-3 d-flex justify-content-center align-items-center gap-1 d-none">
		<img id="nextEventLogo" alt="Next event logo" width="300" height="128" src="/assets/event_supporting_2023.png">
		<img style="display: none;" id="nextEventChapterCharacter" alt="Worldlink chapter character" width="90" height="90">
	</div>

	<div id="nextEventCountdown" class="flipdown mb-3 d-none"></div>

	<hr id="eventSeparator" class="w-100 d-none">
	
	<div id="logoContainer" class="my-3 d-flex justify-content-center align-items-center gap-1">
		<span id="eventLogoPlaceholder" class="placeholder-glow" style="width: 300px; height: 128px;">
			<span class="placeholder rounded-4 w-100 h-100"></span>
		</span>
		<img style="display: none;" id="eventLogo" alt="Event logo" width="300" height="128">
		<img style="display: none;" id="eventChapterCharacter" alt="Worldlink chapter character" width="90" height="90">
	</div>

	<div id="eventCountdownPlaceholder" class="flipdown mb-3 placeholder-glow">
		<span class="placeholder rounded-4 w-100 h-100"></span>
	</div>
	<div style="display: none;" id="eventCountdown" class="flipdown mb-3"></div>

	<div id="rankingContainer" class="row w-100 justify-content-center">
		<div class="col-auto">
			<ul class="nav nav-tabs border-bottom-0" id="chapterTabs" role="tablist" data-bs-theme="light" style="display: none;">
				<li class="nav-item" role="presentation">
					<button class="nav-link active" id="overall-tab" data-bs-toggle="tab" data-bs-target="#overall-tab-pane" type="button" role="tab" aria-controls="overall-tab-pane" aria-selected="true" style="--bs-nav-tabs-link-active-bg: white;">Overall</button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-1-tab" data-bs-toggle="tab" data-bs-target="#chapter-1-tab-pane" type="button" role="tab" aria-controls="chapter-1-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-2-tab" data-bs-toggle="tab" data-bs-target="#chapter-2-tab-pane" type="button" role="tab" aria-controls="chapter-2-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-3-tab" data-bs-toggle="tab" data-bs-target="#chapter-3-tab-pane" type="button" role="tab" aria-controls="chapter-3-tab-pane" aria-selected="false"></button>
				</li>
				<li class="nav-item" role="presentation">
					<button style="display: none;" class="nav-link" id="chapter-4-tab" data-bs-toggle="tab" data-bs-target="#chapter-4-tab-pane" type="button" role="tab" aria-controls="chapter-4-tab-pane" aria-selected="false"></button>
				</li>
			</ul>
			<div id="eventTableCard" class="card" style="background-color: white;">
				<div class="card-body">
					<div class="tab-content">
						<div class="tab-pane fade show active" id="overall-tab-pane" role="tabpanel" aria-labelledby="overall-tab" tabindex="0">
							<table id="eventTableOverall" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col">Past hour</th>
										<th scope="col">Per game</th>
									</tr>
								</thead>
								<tbody id="eventTableOverallBody" class="table-group-divider">
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-8"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-4"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-6"></span></td>
									</tr>
									<tr>
										<td class="placeholder-glow" colspan="5"><span class="placeholder col-10"></span></td>
									</tr>
								</tbody>
							</table>
						</div>
						<div class="tab-pane fade" id="chapter-1-tab-pane" role="tabpanel" aria-labelledby="chapter-1-tab" tabindex="0">
							<table id="eventTableChapter1" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col">Past hour</th>
										<th scope="col">Per game</th>
									</tr>
								</thead>
								<tbody id="eventTableChapter1Body" class="table-group-divider"></tbody>
							</table>
						</div>
						<div class="tab-pane fade" id="chapter-2-tab-pane" role="tabpanel" aria-labelledby="chapter-2-tab" tabindex="0">
							<table id="eventTableChapter2" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col">Past hour</th>
										<th scope="col">Per game</th>
									</tr>
								</thead>
								<tbody id="eventTableChapter2Body" class="table-group-divider"></tbody>
							</table>
						</div>
						<div class="tab-pane fade" id="chapter-3-tab-pane" role="tabpanel" aria-labelledby="chapter-3-tab" tabindex="0">
							<table id="eventTableChapter3" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col">Past hour</th>
										<th scope="col">Per game</th>
									</tr>
								</thead>
								<tbody id="eventTableChapter3Body" class="table-group-divider"></tbody>
							</table>
						</div>
						<div class="tab-pane fade" id="chapter-4-tab-pane" role="tabpanel" aria-labelledby="chapter-4-tab" tabindex="0">
							<table id="eventTableChapter4" class="table table-hover table-light" style="--bs-table-bg: white;">
								<thead>
									<tr>
										<th scope="col">#</th>
										<th scope="col">Name</th>
										<th scope="col">Points</th>
										<th scope="col">Past hour</th>
										<th scope="col">Per game</th>
									</tr>
								</thead>
								<tbody id="eventTableChapter4Body" class="table-group-divider"></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<p id="errorMsg" style="display: none;">Failed to fetch updated leaderboard. Try again later.</p>

	<footer class="py-3">
		<span>Contact: neo@seka.ing</span>
	</footer>

	<script>
		function switchTab(idx) {
			const button = document.querySelector(`#chapterTabs .nav-item:nth-child(${idx + 1}) button`)
			const eventTableCard = document.getElementById("eventTableCard")

			bootstrap.Tab.getInstance(button).show()
			eventTableCard.style.setProperty("background-color", button.style.getPropertyValue("--bs-nav-tabs-link-active-bg"))

			if(idx === 0) {
				eventTableCard.style.setProperty("border-top-left-radius", "0")
			} else {
				eventTableCard.style.removeProperty("border-top-left-radius")
			}

			localStorage.setItem("tabIdx", idx.toString())
		}

		document.querySelectorAll("#chapterTabs button").forEach((x, idx) => {
			const tabTrigger = new bootstrap.Tab(x)
			x.addEventListener("click", event => {
				event.preventDefault()
				switchTab(idx)
			})
		})

		// https://stackoverflow.com/a/13542669
		const pSBC=(p,c0,c1,l)=>{
			let r,g,b,P,f,t,h,i=parseInt,m=Math.round,a=typeof(c1)=="string";
			if(typeof(p)!="number"||p<-1||p>1||typeof(c0)!="string"||(c0[0]!='r'&&c0[0]!='#')||(c1&&!a))return null;
			if(!this.pSBCr)this.pSBCr=(d)=>{
				let n=d.length,x={};
				if(n>9){
					[r,g,b,a]=d=d.split(","),n=d.length;
					if(n<3||n>4)return null;
					x.r=i(r[3]=="a"?r.slice(5):r.slice(4)),x.g=i(g),x.b=i(b),x.a=a?parseFloat(a):-1
				}else{
					if(n==8||n==6||n<4)return null;
					if(n<6)d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]+(n>4?d[4]+d[4]:"");
					d=i(d.slice(1),16);
					if(n==9||n==5)x.r=d>>24&255,x.g=d>>16&255,x.b=d>>8&255,x.a=m((d&255)/0.255)/1000;
					else x.r=d>>16,x.g=d>>8&255,x.b=d&255,x.a=-1
				}return x};
			h=c0.length>9,h=a?c1.length>9?true:c1=="c"?!h:false:h,f=this.pSBCr(c0),P=p<0,t=c1&&c1!="c"?this.pSBCr(c1):P?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},p=P?p*-1:p,P=1-p;
			if(!f||!t)return null;
			if(l)r=m(P*f.r+p*t.r),g=m(P*f.g+p*t.g),b=m(P*f.b+p*t.b);
			else r=m((P*f.r**2+p*t.r**2)**0.5),g=m((P*f.g**2+p*t.g**2)**0.5),b=m((P*f.b**2+p*t.b**2)**0.5);
			a=f.a,t=t.a,f=a>=0||t>=0,a=f?a<0?t:t<0?a:a*P+t*p:0;
			if(h)return"rgb"+(f?"a(":"(")+r+","+g+","+b+(f?","+m(a*1000)/1000:"")+")";
			else return"#"+(4294967296+r*16777216+g*65536+b*256+(f?m(a*255):0)).toString(16).slice(1,f?undefined:-2)
		}

		function formatNumber(num) {
			return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
		}

		let lastUpdatedAt
		function toggleIssuesBanner(toggled, errorType, aggregateUntil) {
			const banner = document.getElementById("issuesBanner")
			const label = document.getElementById("issuesBannerLabel")

			if(toggled) {
				switch(errorType) {
					case "backend":
						label.innerText = `We're experiencing issues. The leaderboard might not be up to date!\nLast update: ${lastUpdatedAt?.toLocaleTimeString() ?? "N/A"}`
						break
					case "network":
						label.innerText = `Your network is offline. The leaderboard cannot update!\nLast update: ${lastUpdatedAt?.toLocaleTimeString() ?? "N/A"}`
						break
					case "aggregate":
						label.innerText = `The leaderboard is being aggregated until ${aggregateUntil.toLocaleTimeString()}!\nLast update: ${lastUpdatedAt?.toLocaleTimeString() ?? "N/A"}`
						break
				}

				banner.style.display = ""
			} else {
				banner.style.display = "none"
			}
		}

		function toggleFailureMessage(toggled) {
			const rankingContainer = document.getElementById("rankingContainer")
			const logoContainer = document.getElementById("logoContainer")
			const logoPlaceholder = document.getElementById("eventCountdownPlaceholder")
			const errorMsg = document.getElementById("errorMsg")

			if(toggled) {
				rankingContainer.style.setProperty("display", "none", "important")
				logoContainer.style.setProperty("display", "none", "important")
				logoPlaceholder.style.setProperty("display", "none", "important")
				errorMsg.style.display = ""
			} else {
				rankingContainer.style.display = logoContainer.style.display = ""
				errorMsg.style.display = "none"
			}
		}

		async function getLeaderboard() {
			try {
				const res = await fetch("/api/leaderboard")
				if(!res.ok) {
					console.error("getLeaderboard() failed (1):", res.status)
					return {errorType: "backend"}
				}

				const json = await res.json()
				return {data: json}
			} catch(ex) {
				console.error("getLeaderboard() failed (2):", ex)
				return {errorType: "network"}
			}
		}

		let timerStarted = false
		let nextTimerStarted = false
		let lastLbUpdate
		let trackHash = localStorage.getItem("trackHash")

		async function doUpdate() {
			if(lastLbUpdate && document.visibilityState === "hidden") {
				return
			}

			const {data, errorType} = await getLeaderboard()
			if(!data) {
				if(!lastLbUpdate) {
					toggleFailureMessage(true)
				} else {
					toggleIssuesBanner(true, errorType)
				}
				return
			}
			lastUpdatedAt = data.updated_at && new Date(data.updated_at)
			
			toggleFailureMessage(false)
			if(data.update_error || (lastUpdatedAt && (Date.now() - lastUpdatedAt.getTime() > 3 * 60 * 1000))) {
				toggleIssuesBanner(true, "backend")
			} else if(data.aggregate_until) {
				toggleIssuesBanner(true, "aggregate", new Date(data.aggregate_until))
			} else {
				toggleIssuesBanner(false)
			}
			
			const eventData = data.event
			document.getElementById("eventLogoPlaceholder").style.display = "none"
			document.getElementById("eventLogo").setAttribute("src", `assets/${eventData.name_key}.png`)
			document.getElementById("eventLogo").style.display = ""
			if(eventData.chapter_character) {
				document.getElementById("eventChapterCharacter").style.display = ""
				document.getElementById("eventChapterCharacter").setAttribute("src", `assets/character_${eventData.chapter_character}.png`)
			} else {
				document.getElementById("eventChapterCharacter").style.display = "none"
			}
			if(eventData.ends_at && !timerStarted) {
				timerStarted = true

				document.getElementById("eventCountdownPlaceholder").style.display = "none"
				document.getElementById("eventCountdown").style.display = ""
				
				const eventEndsAt = new Date(eventData.ends_at)
				const flipdown = new FlipDown(Math.floor(eventEndsAt.getTime()/1000), "eventCountdown", {theme: "light"})
				flipdown.start()
			}

			const nextEventData = data.next_event
			if(nextEventData) {
				document.getElementById("nextLogoContainer").classList.remove("d-none")
				document.getElementById("nextEventLogo").setAttribute("src", `assets/${nextEventData.name_key}.png`)

				if(nextEventData.chapter_character) {
					document.getElementById("nextEventChapterCharacter").style.display = ""
					document.getElementById("nextEventChapterCharacter").setAttribute("src", `assets/character_${nextEventData.chapter_character}.png`)
				}

				if(nextEventData.starts_at && !nextTimerStarted) {
					nextTimerStarted = true
					document.getElementById("nextEventCountdown").classList.remove("d-none")
					
					const eventStartsAt = new Date(nextEventData.starts_at)
					const flipdown = new FlipDown(Math.floor(eventStartsAt.getTime()/1000), "nextEventCountdown", {theme: "light"})
					flipdown.start()
				}

				document.getElementById("eventSeparator").classList.remove("d-none")
			} else {
				document.getElementById("nextLogoContainer").classList.add("d-none")
				document.getElementById("nextEventCountdown").classList.add("d-none")
				document.getElementById("eventSeparator").classList.add("d-none")
			}

			updateLeaderboard(document.getElementById("eventTableOverall"), data.rankings)

			if(data.chapter_rankings) {
				document.getElementById("chapterTabs").style.removeProperty("display")
				document.getElementById("eventTableCard").style.setProperty("border-top-left-radius", "0")
				
				for(const chapter of data.event.chapters) {
					const color = pSBC(0.7, chapter.color)
					const hoverColor = pSBC(0.5, chapter.color)
					const button = document.getElementById(`chapter-${chapter.num}-tab`)
					button.innerText = chapter.title
					button.style.setProperty("--bs-nav-tabs-link-active-bg", color)
					button.style.display = ""
					
					const tbl = document.getElementById("eventTableChapter" + chapter.num)
					tbl.style.setProperty("--bs-table-bg", color)
					tbl.style.setProperty("--bs-table-hover-bg", hoverColor)
				}
				
				for(const [idx, rankings] of data.chapter_rankings.entries()) {
					updateLeaderboard(document.getElementById("eventTableChapter" + (idx + 1)), rankings)
				}

				if(!lastLbUpdate) {
					const idx = localStorage.getItem("tabIdx") ?? data.event.chapters.find(x => x.current)?.num
					if(idx) {
						switchTab(+idx)
					}
				}
			}

			lastLbUpdate = new Date()
		}

		function updateLeaderboard(table, rankings) {
			const tableBody = table.querySelector("tbody")
			while(tableBody.firstChild) {
				tableBody.removeChild(tableBody.lastChild)
			}

			let scrollTo
			for(const slot of rankings) {
				const tableRow = document.createElement("tr")

				const rankCell = document.createElement("td")
				const nameCell = document.createElement("td")
				const nameCellDiv = document.createElement("div")
				const pointsCell = document.createElement("td")
				const deltaCell = document.createElement("td")
				const avgCell = document.createElement("td")

				rankCell.setAttribute("scope", "row")
				if([1,2,3].includes(slot.rank)) {
					rankCell.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-crown w-6 h-6 text-yellow-400"><path d="M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z"></path><path d="M5 21h14"></path></svg>`
				} else {
					rankCell.innerText = slot.rank
				}

				nameCellDiv.setAttribute("class", "d-flex align-items-center gap-1 username-cell")
				if(slot.team != null) {
					const teamImg = document.createElement("img")
					teamImg.setAttribute("src", `/assets/team_${slot.team}.png`)
					teamImg.setAttribute("width", "20")
					teamImg.setAttribute("height", "20")

					nameCellDiv.appendChild(teamImg)
				}
				const nameLabel = document.createElement("span")
				nameLabel.setAttribute("class", "username-label")
				nameLabel.innerText = slot.name
				nameCellDiv.appendChild(nameLabel)
				nameCell.appendChild(nameCellDiv)

				pointsCell.innerText = formatNumber(slot.score)
				deltaCell.innerText = !!slot.delta ? "+" + formatNumber(slot.delta) : "-"
				avgCell.innerText = !!slot.average ? "+" + formatNumber(Math.floor(slot.average)) : "-"

				if([3, 10, 50].includes(slot.rank - 1)) {
					tableRow.classList.add("class", "table-group-divider")
				}
				if(trackHash === slot.hash) {
					tableRow.classList.add("table-row-tracked")
					scrollTo = tableRow
				}

				rankCell.setAttribute("class", "fw-bold text-center")
				switch(slot.rank) {
					case 1:
						rankCell.style.color = "#facc15"
						break
					case 2:
						rankCell.style.color = "#9ca3af"
						break
					case 3:
						rankCell.style.color = "#d97706"
						break
					default:
						rankCell.style.color = "#00ccbb"
						break
				}
				pointsCell.style.color = "#ff55ab"

				tableRow.appendChild(rankCell)
				tableRow.appendChild(nameCell)
				tableRow.appendChild(pointsCell)
				tableRow.appendChild(deltaCell)
				tableRow.appendChild(avgCell)

				tableBody.appendChild(tableRow)

				tableRow.addEventListener("click", function() {
					if(trackHash === slot.hash) {
						trackHash = null
						localStorage.removeItem("trackHash")
						this.classList.remove("table-row-tracked")
					} else {
						trackHash = slot.hash
						localStorage.setItem("trackHash", slot.hash)
						document.querySelector(".table-row-tracked")?.classList?.remove("table-row-tracked")
						this.classList.add("table-row-tracked")
					}
				})
			}

			if(scrollTo) {
				scrollTo.scrollIntoView({behavior: "smooth", block: "center"})
			}
		}

		doUpdate()
		setInterval(doUpdate, 30 * 1000)

		document.addEventListener("visibilitychange", async function() {
			if(!lastLbUpdate) return

			const secondsDiff = (Date.now() - lastLbUpdate.getTime())/1000
			if(document.visibilityState === "visible" && secondsDiff >= 20) {
				await doUpdate()
			}
		})
	</script>
</body>
</html>